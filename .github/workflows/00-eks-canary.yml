name: EKS-Canary

on:
  push:
# https://docs.github.com/en/free-pro-team@latest/rest/actions/workflows?apiVersion=2022-11-28#create-a-workflow-dispatch-event
  workflow_dispatch:
    # inputs:
    #   subsys:
    #     type: string
    #     default: inputValue
    #   sigla:
    #     type: string
    #     default: SC4
    #   jobsuccess:
    #     type: string
    #     default: sucesso
    #   jobfailed:
    #     type: string
    #     default: falha
#   repository_dispatch:
#     types: [on-demand-test]

env:
  MY_WORKFLOW_VARIABLE: "My workflow var value"
  SIGLA: ""

jobs:
  eks-onebox-gradual-deployment:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      actions: read
    steps:
      - uses: azure/setup-kubectl@v3
        # with:
        #   version: '<version>' # default is latest stable
        id: install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-2

      - name: Update kube config
        run: aws eks update-kubeconfig --name cell-1 --region us-east-2

      - name: List pods
        run: |
          kubectl get pods

      - name: Query AWS CloudWatch Alarm State
        id: check_alarm
        run: |
          ALARM_STATE=$(aws cloudwatch describe-alarms --alarm-names "cell-1-onebox-cpu-utilization-anomaly-detection" --query "MetricAlarms[0].StateValue" --output text)
          echo "Alarm state: $ALARM_STATE"
          if [ "$ALARM_STATE" = "ALARM" ]; then
            echo "::set-output name=alarm_triggered::true"
          fi

      - name: Handle ALARM state
        if: steps.check_alarm.outputs.alarm_triggered == 'true'
        run: |
          echo "Alarm state is ALARM. Handling error..."
          # Here you can add specific actions, such as sending notifications, triggering other workflows, or rolling back deployments
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4.1.3
        with:
          # repository: sudopablosilva/argo
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v5.1.0

      - name: Install Python dependencies
        run: python -m pip install pyyaml

      - name: Deploy to Clusters
        env:
          serviceName: openfinance
          templatePath: applicationsets.yaml
        run: python adapt_applicationsets.py
